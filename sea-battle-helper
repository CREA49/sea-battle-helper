<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Sea Battle / Battleship Helper</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <style>
    :root {
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
      background: #0b1020;
      color: #f5f5f5;
    }

    body {
      margin: 0;
      padding: 20px;
      display: flex;
      justify-content: center;
    }

    .app {
      max-width: 1100px;
      width: 100%;
      background: #151a30;
      border-radius: 16px;
      box-shadow: 0 20px 40px rgba(0, 0, 0, 0.5);
      padding: 20px 24px 28px;
      box-sizing: border-box;
    }

    h1 {
      margin: 0;
      font-size: 1.6rem;
      display: flex;
      align-items: center;
      gap: 10px;
    }

    h1 span {
      font-size: 1.1rem;
      color: #9ea7ff;
      font-weight: 500;
    }

    .subtitle {
      margin-top: 4px;
      color: #a0a6c4;
      font-size: 0.9rem;
    }

    .layout {
      display: grid;
      grid-template-columns: minmax(0, 2fr) minmax(0, 1.35fr);
      gap: 24px;
      margin-top: 20px;
    }

    @media (max-width: 900px) {
      .layout {
        grid-template-columns: 1fr;
      }
    }

    .panel {
      background: #1a2140;
      border-radius: 14px;
      padding: 14px 16px 16px;
      box-sizing: border-box;
      border: 1px solid #242b4d;
    }

    .panel h2 {
      margin: 0 0 6px;
      font-size: 1rem;
      display: flex;
      align-items: center;
      justify-content: space-between;
    }

    .panel small {
      color: #8d93b8;
      font-size: 0.8rem;
    }

    .controls-row {
      display: flex;
      flex-wrap: wrap;
      gap: 12px;
      margin-bottom: 10px;
      align-items: center;
    }

    label {
      font-size: 0.85rem;
      color: #c3c7e8;
    }

    select,
    button {
      font-family: inherit;
      border-radius: 999px;
      border: 1px solid #343b65;
      background: #20264a;
      color: #f5f5f5;
      padding: 6px 12px;
      font-size: 0.85rem;
      cursor: pointer;
      outline: none;
    }

    select:focus,
    button:focus {
      border-color: #5b84ff;
      box-shadow: 0 0 0 1px rgba(91, 132, 255, 0.5);
    }

    button {
      display: inline-flex;
      align-items: center;
      gap: 6px;
      border-radius: 999px;
      border: 1px solid #4650a8;
      background: linear-gradient(135deg, #3d4ef0, #7f5dff);
    }

    button.secondary {
      background: #20264a;
      border-color: #343b65;
    }

    button.mode-btn {
      background: #20264a;
      border-radius: 999px;
      padding: 5px 10px;
      border: 1px solid #343b65;
      font-size: 0.8rem;
    }

    button.mode-btn.active {
      background: #3d4ef0;
      border-color: #5b84ff;
    }

    .mode-buttons {
      display: flex;
      gap: 6px;
      flex-wrap: wrap;
    }

    .legend {
      display: flex;
      gap: 10px;
      flex-wrap: wrap;
      margin-top: 8px;
      font-size: 0.8rem;
      color: #9fa5d5;
    }

    .legend-item {
      display: inline-flex;
      align-items: center;
      gap: 4px;
    }

    .legend-swatch {
      width: 14px;
      height: 14px;
      border-radius: 3px;
      border: 1px solid #343b65;
    }

    .board-wrapper {
      margin-top: 10px;
      overflow-x: auto;
      padding-bottom: 4px;
    }

    .board {
      display: grid;
      grid-template-columns: 24px repeat(10, 32px);
      grid-auto-rows: 24px;
      gap: 2px;
      user-select: none;
    }

    .board-size-8 {
      grid-template-columns: 24px repeat(8, 32px);
    }

    .board-size-9 {
      grid-template-columns: 24px repeat(9, 32px);
    }

    .board-header-cell,
    .board-row-label {
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 0.7rem;
      color: #8f95c4;
    }

    .cell {
      width: 32px;
      height: 32px;
      border-radius: 6px;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 0.7rem;
      cursor: pointer;
      border: 1px solid #283054;
      box-sizing: border-box;
      position: relative;
      overflow: hidden;
    }

    .cell.unknown {
      background: #14182d;
    }

    .cell.miss {
      background: #2b324c;
      border-color: #3c4464;
    }

    .cell.hit {
      background: #ff4d6a;
      border-color: #ff98ae;
      color: #fff;
      font-weight: 600;
    }

    .cell.best {
      box-shadow: 0 0 0 2px #ffdd7f;
    }

    .cell-score {
      position: absolute;
      inset: 0;
      pointer-events: none;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 0.65rem;
      color: #fdfdfd;
      text-shadow: 0 1px 2px rgba(0, 0, 0, 0.9);
    }

    .cell-bg {
      position: absolute;
      inset: 0;
      border-radius: inherit;
      opacity: 0.85;
    }

    .ships-list {
      display: flex;
      flex-wrap: wrap;
      gap: 8px 12px;
      margin-top: 4px;
    }

    .ship-chip {
      display: inline-flex;
      align-items: center;
      gap: 4px;
      padding: 4px 8px;
      border-radius: 999px;
      background: #20264a;
      border: 1px solid #343b65;
      font-size: 0.8rem;
    }

    .ship-chip input {
      accent-color: #5b84ff;
    }

    .status {
      margin-top: 8px;
      font-size: 0.8rem;
      color: #9ea7ff;
    }

    .best-list {
      margin-top: 8px;
      font-size: 0.85rem;
      color: #d4d8ff;
    }

    .best-list span.coord {
      display: inline-block;
      padding: 3px 7px;
      margin-right: 6px;
      margin-bottom: 4px;
      border-radius: 999px;
      background: #252c55;
      border: 1px solid #3a4280;
      font-size: 0.78rem;
    }

    .footer-note {
      margin-top: 14px;
      font-size: 0.75rem;
      color: #7c83b0;
    }
  </style>
</head>
<body>
<div class="app">
  <h1>
    Sea Battle Helper
    <span>GamePigeon / Battleship board solver</span>
  </h1>
  <div class="subtitle">
    Mark your hits & misses from the GamePigeon Sea Battle board. This tool calculates which cells are most likely to contain ships.
  </div>

  <div class="layout">
    <!-- LEFT: BOARD -->
    <div class="panel">
      <h2>
        Board
        <small>Click to mark cells, solver updates automatically.</small>
      </h2>

      <div class="controls-row">
        <label>
          Board size:
          <select id="boardSizeSelect">
            <option value="8">8 × 8</option>
            <option value="9">9 × 9</option>
            <option value="10" selected>10 × 10</option>
          </select>
        </label>

        <div class="mode-buttons">
          <button type="button" class="mode-btn active" data-mode="miss">Miss</button>
          <button type="button" class="mode-btn" data-mode="hit">Hit</button>
          <button type="button" class="mode-btn" data-mode="clear">Clear</button>
        </div>

        <button type="button" id="resetBoardBtn" class="secondary">
          Reset board
        </button>
      </div>

      <div class="legend">
        <div class="legend-item">
          <span class="legend-swatch" style="background:#14182d;"></span> Unknown
        </div>
        <div class="legend-item">
          <span class="legend-swatch" style="background:#2b324c;"></span> Miss
        </div>
        <div class="legend-item">
          <span class="legend-swatch" style="background:#ff4d6a;"></span> Hit
        </div>
        <div class="legend-item">
          <span class="legend-swatch" style="background:linear-gradient(135deg,#203a1f,#47c572);"></span> High probability
        </div>
      </div>

      <div class="board-wrapper">
        <div id="board" class="board board-size-10"></div>
      </div>
    </div>

    <!-- RIGHT: SHIPS + RESULTS -->
    <div class="panel">
      <h2>
        Ships & Best Shots
        <small>Toggle ships remaining to match your game.</small>
      </h2>

      <div>
        <div style="font-size:0.85rem; color:#c3c7e8;">Fleet configuration:</div>
        <div class="ships-list" id="shipsList">
          <!-- filled by JS -->
        </div>
      </div>

      <div class="status" id="statusText">
        Waiting for board input…
      </div>

      <div class="best-list">
        <div style="margin-bottom:4px; font-weight:500;">Best shots:</div>
        <div id="bestShots"></div>
      </div>

      <div class="footer-note">
        Tip: In the early game, the solver prefers central, spread-out shots. Once you get hits, it naturally clusters probabilities around them.
      </div>
    </div>
  </div>
</div>

<script>
  // ===== Model =====
  const boardEl = document.getElementById("board");
  const boardSizeSelect = document.getElementById("boardSizeSelect");
  const resetBoardBtn = document.getElementById("resetBoardBtn");
  const shipsListEl = document.getElementById("shipsList");
  const statusText = document.getElementById("statusText");
  const bestShotsEl = document.getElementById("bestShots");

  const modeButtons = Array.from(document.querySelectorAll(".mode-btn"));
  let currentMode = "miss"; // "miss" | "hit" | "clear"

  // 0 = unknown, 1 = miss, 2 = hit
  let size = parseInt(boardSizeSelect.value, 10);
  let board = createEmptyBoard(size);
  let scores = createEmptyBoard(size);

  // Standard Battleship / Sea Battle fleet
  const baseFleet = [
    { id: "ship5", len: 5, label: "Carrier (5)" },
    { id: "ship4", len: 4, label: "Battleship (4)" },
    { id: "ship3a", len: 3, label: "Cruiser (3)" },
    { id: "ship3b", len: 3, label: "Submarine (3)" },
    { id: "ship2", len: 2, label: "Destroyer (2)" },
  ];

  // ===== Setup UI =====
  function createEmptyBoard(n) {
    const b = [];
    for (let r = 0; r < n; r++) {
      const row = new Array(n).fill(0);
      b.push(row);
    }
    return b;
  }

  function initFleetUI() {
    shipsListEl.innerHTML = "";
    baseFleet.forEach(ship => {
      const chip = document.createElement("label");
      chip.className = "ship-chip";

      const checkbox = document.createElement("input");
      checkbox.type = "checkbox";
      checkbox.id = ship.id;
      checkbox.checked = true;
      checkbox.dataset.len = ship.len.toString();

      checkbox.addEventListener("change", () => {
        recomputeScores();
      });

      const text = document.createElement("span");
      text.textContent = ship.label;

      chip.appendChild(checkbox);
      chip.appendChild(text);
      shipsListEl.appendChild(chip);
    });
  }

  function initBoardUI() {
    boardEl.innerHTML = "";
    boardEl.classList.remove("board-size-8", "board-size-9", "board-size-10");
    boardEl.classList.add("board-size-" + size);

    // Top-left corner empty
    const corner = document.createElement("div");
    corner.className = "board-header-cell";
    boardEl.appendChild(corner);

    // Column labels
    for (let c = 0; c < size; c++) {
      const label = document.createElement("div");
      label.className = "board-header-cell";
      label.textContent = c + 1;
      boardEl.appendChild(label);
    }

    // Rows with labels + cells
    for (let r = 0; r < size; r++) {
      const rowLabel = document.createElement("div");
      rowLabel.className = "board-row-label";
      rowLabel.textContent = String.fromCharCode(65 + r);
      boardEl.appendChild(rowLabel);

      for (let c = 0; c < size; c++) {
        const cell = document.createElement("div");
        cell.className = "cell unknown";
        cell.dataset.row = r.toString();
        cell.dataset.col = c.toString();

        cell.addEventListener("click", () => {
          onCellClick(r, c);
        });

        const bg = document.createElement("div");
        bg.className = "cell-bg";
        cell.appendChild(bg);

        const scoreLabel = document.createElement("div");
        scoreLabel.className = "cell-score";
        cell.appendChild(scoreLabel);

        boardEl.appendChild(cell);
      }
    }
  }

  function onCellClick(r, c) {
    if (currentMode === "miss") {
      board[r][c] = 1;
    } else if (currentMode === "hit") {
      board[r][c] = 2;
    } else if (currentMode === "clear") {
      board[r][c] = 0;
    }
    recomputeScores();
  }

  modeButtons.forEach(btn => {
    btn.addEventListener("click", () => {
      modeButtons.forEach(b => b.classList.remove("active"));
      btn.classList.add("active");
      currentMode = btn.dataset.mode;
    });
  });

  boardSizeSelect.addEventListener("change", () => {
    size = parseInt(boardSizeSelect.value, 10);
    board = createEmptyBoard(size);
    scores = createEmptyBoard(size);
    initBoardUI();
    recomputeScores();
  });

  resetBoardBtn.addEventListener("click", () => {
    board = createEmptyBoard(size);
    scores = createEmptyBoard(size);
    initBoardUI();
    recomputeScores();
  });

  // ===== Solver Logic =====

  function getRemainingShips() {
    const checked = Array.from(
      shipsListEl.querySelectorAll("input[type=checkbox]")
    ).filter(cb => cb.checked);
    return checked.map(cb => parseInt(cb.dataset.len, 10));
  }

  // Valid if:
  // - ship fits in board
  // - does NOT overlap any miss
  // - optionally gets bonus if it overlaps hits
  function isValidPlacement(shipLen, startR, startC, dr, dc) {
    let hasConflict = false;
    for (let i = 0; i < shipLen; i++) {
      const r = startR + dr * i;
      const c = startC + dc * i;
      const cell = board[r][c];
      if (cell === 1) {
        // Miss: ship cannot be here
        hasConflict = true;
        break;
      }
    }
    return !hasConflict;
  }

  function countHitsInPlacement(shipLen, startR, startC, dr, dc) {
    let hits = 0;
    for (let i = 0; i < shipLen; i++) {
      const r = startR + dr * i;
      const c = startC + dc * i;
      if (board[r][c] === 2) hits++;
    }
    return hits;
  }

  function recomputeScores() {
    const ships = getRemainingShips();
    scores = createEmptyBoard(size);

    const anyHits = board.some(row => row.some(v => v === 2));

    if (ships.length === 0) {
      updateBoardUI();
      statusText.textContent = "No ships selected. Check at least one ship to calculate probabilities.";
      bestShotsEl.innerHTML = "";
      return;
    }

    // For each ship, slide horizontally and vertically
    ships.forEach(shipLen => {
      // Horizontal placements
      for (let r = 0; r < size; r++) {
        for (let c = 0; c <= size - shipLen; c++) {
          if (!isValidPlacement(shipLen, r, c, 0, 1)) continue;

          const hitsCovered = countHitsInPlacement(shipLen, r, c, 0, 1);
          if (anyHits && hitsCovered === 0) {
            // Slight penalty: if we already have hits, prefer placements that
            // overlap them. Don't completely discard, just lower weight.
            var weight = 0.5;
          } else {
            var weight = 1 + hitsCovered * 2; // more hits = stronger placement
          }

          for (let i = 0; i < shipLen; i++) {
            const rr = r + 0 * i;
            const cc = c + 1 * i;
            if (board[rr][cc] !== 1) {
              scores[rr][cc] += weight;
            }
          }
        }
      }

      // Vertical placements
      for (let c = 0; c < size; c++) {
        for (let r = 0; r <= size - shipLen; r++) {
          if (!isValidPlacement(shipLen, r, c, 1, 0)) continue;

          const hitsCovered = countHitsInPlacement(shipLen, r, c, 1, 0);
          if (anyHits && hitsCovered === 0) {
            var weightV = 0.5;
          } else {
            var weightV = 1 + hitsCovered * 2;
          }

          for (let i = 0; i < shipLen; i++) {
            const rr = r + 1 * i;
            const cc = c + 0 * i;
            if (board[rr][cc] !== 1) {
              scores[rr][cc] += weightV;
            }
          }
        }
      }
    });

    updateBoardUI();
    updateBestShots();
  }

  // Update the board colors and score numbers in the DOM
  function updateBoardUI() {
    let maxScore = 0;
    for (let r = 0; r < size; r++) {
      for (let c = 0; c < size; c++) {
        if (scores[r][c] > maxScore) {
          maxScore = scores[r][c];
        }
      }
    }
    const cells = boardEl.querySelectorAll(".cell");
    cells.forEach(cell => {
      const r = parseInt(cell.dataset.row, 10);
      const c = parseInt(cell.dataset.col, 10);
      const state = board[r][c];
      const score = scores[r][c];

      cell.classList.remove("unknown", "miss", "hit", "best");

      if (state === 1) {
        cell.classList.add("miss");
      } else if (state === 2) {
        cell.classList.add("hit");
      } else {
        cell.classList.add("unknown");
      }

      const bg = cell.querySelector(".cell-bg");
      const scoreLabel = cell.querySelector(".cell-score");

      if (maxScore > 0 && score > 0) {
        const t = score / maxScore; // 0..1
        const clamped = Math.max(0, Math.min(1, t));
        // Color gradient: dark green -> bright lime
        const rCol = Math.round(32 + 80 * clamped);
        const gCol = Math.round(80 + 140 * clamped);
        const bCol = Math.round(48 + 40 * clamped);
        bg.style.background = `rgb(${rCol}, ${gCol}, ${bCol})`;
        bg.style.opacity = state === 1 ? 0.2 : 0.9;
        scoreLabel.textContent = score.toFixed(0);
      } else {
        bg.style.background = "transparent";
        bg.style.opacity = 0;
        scoreLabel.textContent = "";
      }
    });
  }

  function updateBestShots() {
    // Find top unknown cells by score
    let maxScore = 0;
    const candidates = [];
    for (let r = 0; r < size; r++) {
      for (let c = 0; c < size; c++) {
        if (board[r][c] === 0 && scores[r][c] > 0) {
          if (scores[r][c] > maxScore) {
            maxScore = scores[r][c];
          }
        }
      }
    }

    // Clear best class
    const allCells = boardEl.querySelectorAll(".cell");
    allCells.forEach(cell => cell.classList.remove("best"));

    bestShotsEl.innerHTML = "";

    if (maxScore <= 0) {
      statusText.textContent = "No valid ship placements yet. Start marking misses and hits to see probabilities.";
      return;
    }

    for (let r = 0; r < size; r++) {
      for (let c = 0; c < size; c++) {
        if (board[r][c] === 0 && scores[r][c] === maxScore) {
          candidates.push({ r, c });
        }
      }
    }

    // Highlight top 5
    const top = candidates.slice(0, 5);
    top.forEach(pos => {
      const coord = coordFromRC(pos.r, pos.c);
      const span = document.createElement("span");
      span.className = "coord";
      span.textContent = coord;
      bestShotsEl.appendChild(span);

      const cell = getCellElement(pos.r, pos.c);
      if (cell) cell.classList.add("best");
    });

    statusText.textContent = `Highest probability cells (based on remaining ships and your hits/misses):`;
  }

  function coordFromRC(r, c) {
    return String.fromCharCode(65 + r) + (c + 1);
  }

  function getCellElement(r, c) {
    return boardEl.querySelector(`.cell[data-row="${r}"][data-col="${c}"]`);
  }

  // ===== Initialize =====
  initFleetUI();
  initBoardUI();
  recomputeScores();
</script>
</body>
</html>
